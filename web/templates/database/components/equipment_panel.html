{% from "database/components/base_panel.html" import database_panel %}

{% set filters_content %}
<!-- Equipment Filters -->
<div class="space-y-4">
    <!-- Slot Filter -->
    <div>
        <label class="block text-sm font-medium text-lotro-primary mb-2">
            <span>Slot</span>
            <span x-show="isSlotFilterLocked" class="text-xs text-lotro-uncommon ml-2">🔒 Locked for this slot</span>
        </label>
        <select x-model="selectedSlot" 
                @change="applyFilters()"
                :disabled="isSlotFilterLocked"
                :class="isSlotFilterLocked ? 'bg-lotro-darker border border-lotro-border text-lotro-muted cursor-not-allowed' : 'bg-lotro-darker border border-lotro-border text-lotro-primary focus:border-lotro-gold focus:outline-none'"
                class="w-full rounded-lg px-3 py-2">
            <option value="">All Slots</option>
            <template x-for="filterOption in filterOptions" :key="filterOption.key">
                <option :value="filterOption.key" x-text="filterOption.label"></option>
            </template>
        </select>
    </div>
</div>
{% endset %}

{% set results_content %}
<!-- Equipment Grid -->
<div class="grid grid-cols-3 gap-4">
    <template x-for="(item, index) in equipment" :key="item.key">
        <div class="bg-lotro-darker rounded-lg border border-lotro-border p-4 hover:border-lotro-gold transition-colors duration-200 cursor-pointer relative h-24"
             @click="selectEquipment(item)">
            <!-- Equipment Key -->
            <div class="absolute top-1 left-1 text-xs text-lotro-muted" 
                 x-text="item.key.toString().replace(/(\d{5})(\d+)/, '$1 $2')"></div>
            
            <!-- Main Content -->
            <div class="flex items-center gap-3 h-full pt-2">
                <!-- Equipment Icon (layered) -->
                <div class="w-10 h-10 flex-shrink-0 relative">
                    <template x-if="item.icon_urls && Array.isArray(item.icon_urls)">
                        <template x-for="(url, i) in [...item.icon_urls].reverse()" :key="i">
                            <img :src="url" 
                                 :alt="'Equipment icon layer ' + (i + 1)"
                                 class="absolute inset-0 w-full h-full object-contain"
                                 @error="$el.style.display='none'">
                        </template>
                    </template>
                    <template x-if="!item.icon_urls || !Array.isArray(item.icon_urls)">
                        <div class="w-full h-full bg-lotro-button rounded"></div>
                    </template>
                </div>
                
                <!-- Equipment Name -->
                <h3 class="text-sm font-medium line-clamp-2 leading-tight flex-1"
                    :class="{
                        'text-lotro-common': item.quality === 'COMMON',
                        'text-lotro-uncommon': item.quality === 'UNCOMMON',
                        'text-lotro-rare': item.quality === 'RARE',
                        'text-lotro-incomparable': item.quality === 'INCOMPARABLE',
                        'text-lotro-legendary': item.quality === 'LEGENDARY'
                    }"
                    x-text="item.name"></h3>
            </div>
            
            <!-- EV Value -->
            <div x-show="isBuilderMode()" class="absolute bottom-1 right-2 text-sm font-medium"
                 :class="testMode ? getTestColorClass(index) : getEvColorClass(item.ev)">
                <span x-text="(item.ev || '0.00')"></span>
            </div>
        </div>
    </template>
</div>
{% endset %}

{% set details_content %}
<!-- Equipment Details -->
<template x-if="selectedEquipment">
    <div class="space-y-4">
        <!-- Icon and Title -->
        <div class="space-y-2">
            <!-- Icon and Title -->
            <div class="flex items-start gap-4">
                <!-- Equipment Icon (layered) -->
                <div class="w-16 h-16 flex-shrink-0 relative">
                    <template x-if="selectedEquipment && selectedEquipment.icon_urls && Array.isArray(selectedEquipment.icon_urls)">
                        <div>
                            <template x-for="(url, i) in selectedEquipmentIconUrls" :key="i">
                                <img :src="url" 
                                     :alt="'Equipment icon layer ' + (i + 1)"
                                     class="absolute inset-0 w-full h-full object-contain"
                                     @error="$el.style.display='none'">
                            </template>
                        </div>
                    </template>
                    <template x-if="!selectedEquipment || !selectedEquipment.icon_urls || !Array.isArray(selectedEquipment.icon_urls)">
                        <div class="w-full h-full bg-lotro-button rounded"></div>
                    </template>
                </div>
                
                <!-- Equipment Info -->
                <div class="flex-1 min-w-0">
                    <!-- Title area with fixed height -->
                    <div class="h-16 flex items-center">
                        <h3 class="text-xl font-bold line-clamp-2"
                            :class="{
                                'text-lotro-common': selectedEquipment && selectedEquipment.quality === 'COMMON',
                                'text-lotro-uncommon': selectedEquipment && selectedEquipment.quality === 'UNCOMMON',
                                'text-lotro-rare': selectedEquipment && selectedEquipment.quality === 'RARE',
                                'text-lotro-incomparable': selectedEquipment && selectedEquipment.quality === 'INCOMPARABLE',
                                'text-lotro-legendary': selectedEquipment && selectedEquipment.quality === 'LEGENDARY'
                            }"
                            x-text="selectedEquipmentName"></h3>
                    </div>
                </div>
            </div>

            <!-- Baseline Stats Row -->
            <div class="flex justify-between items-center text-sm text-lotro-secondary -mt-1">
                <div>
                    <span>iLvl: </span>
                    <span x-text="selectedEquipmentBaseIlvl"></span>
                </div>
                <div class="text-lotro-muted">
                    <!-- Weapon display logic -->
                    <template x-if="selectedEquipment && selectedEquipment.weapon_type">
                        <span x-text="selectedEquipment ? selectedEquipment.weapon_type : ''"></span>
                    </template>
                    <!-- Regular equipment display logic -->
                    <template x-if="selectedEquipment && !selectedEquipment.weapon_type && selectedEquipment.armour_type && selectedEquipment.slot === 'OFF_HAND'">
                        <span x-text="selectedEquipment ? selectedEquipment.armour_type : ''"></span>
                    </template>
                    <template x-if="selectedEquipment && !selectedEquipment.weapon_type && selectedEquipment.armour_type && selectedEquipment.slot !== 'OFF_HAND'">
                        <span x-text="selectedEquipment ? (selectedEquipment.slot + ' / ' + selectedEquipment.armour_type) : ''"></span>
                    </template>
                    <template x-if="selectedEquipment && !selectedEquipment.weapon_type && !selectedEquipment.armour_type">
                        <span x-text="selectedEquipment ? selectedEquipment.slot : ''"></span>
                    </template>
                </div>
                <div class="text-lotro-muted font-medium"
                     x-show="isBuilderMode()"
                     :class="testMode ? 'text-lotro-rare' : (selectedEquipment ? getEvColorClass(selectedEquipment.ev) : 'text-lotro-secondary')"
                     x-text="selectedEquipmentEv"></div>
            </div>
            
            <!-- Weapon DPS display (replaces ARMOUR for weapons) -->
            <template x-if="concreteEquipment && concreteEquipment.weapon_type && concreteEquipment.calculated_dps">
                <div class="flex justify-between text-sm text-lotro-secondary mb-2">
                    <span>DPS</span>
                    <span class="text-lotro-primary" x-text="concreteEquipment && concreteEquipment.calculated_dps ? concreteEquipment.calculated_dps.toFixed(1) : '0.0'"></span>
                </div>
            </template>
            
            <!-- ARMOUR stat above the line (only for non-weapons) -->
            <template x-if="concreteEquipment && !concreteEquipment.weapon_type && concreteEquipmentArmour !== null">
                <div class="flex justify-between text-sm text-lotro-secondary mb-2">
                    <span>ARMOUR</span>
                    <span class="text-lotro-primary" x-text="concreteEquipmentArmour"></span>
                </div>
            </template>
            
            <!-- Equipment Stats -->
            <div class="border-t border-lotro-border pt-3">
                <div class="text-sm text-lotro-secondary space-y-1">
                    <!-- Other stats -->
                    <template x-if="concreteEquipment && concreteEquipment.stat_values && Array.isArray(concreteEquipment.stat_values)">
                        <div class="space-y-1">
                            <template x-for="stat in concreteEquipmentStats" :key="stat.stat_name">
                                <div class="flex justify-between">
                                    <span x-text="stat.stat_name"></span>
                                    <span class="text-lotro-primary" x-text="Math.floor(stat.value)"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                    
                    <!-- Fallback when stats fail to load -->
                    <template x-if="selectedEquipment && !concreteEquipment">
                        <div class="text-lotro-muted text-center py-2">
                            <span class="text-xs">Loading detailed stats...</span>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Socket Information -->
            <template x-if="selectedEquipment && selectedEquipment.sockets && selectedEquipment.sockets.total > 0">
                <div class="flex flex-wrap gap-2 mt-2 justify-end">
                    <!-- Socket icons in order: Necklace > Cloak > Primary > Vital > Basic > PVP -->
                    
                    <!-- Necklace sockets (type 20) -->
                    <template x-for="i in (selectedEquipment && selectedEquipment.sockets && selectedEquipment.sockets.necklace) || 0" :key="'necklace-' + i">
                        <div class="w-8 h-8 relative flex-shrink-0">
                            <img src="/static/icons/sockets/background-20.png" alt="Necklace socket background" class="absolute inset-0 w-full h-full">
                            <img src="/static/icons/sockets/overlay-20.png" alt="Necklace socket overlay" class="absolute inset-0 w-full h-full">
                        </div>
                    </template>
                    
                    <!-- Cloak sockets (type 19) -->
                    <template x-for="i in (selectedEquipment && selectedEquipment.sockets && selectedEquipment.sockets.cloak) || 0" :key="'cloak-' + i">
                        <div class="w-8 h-8 relative flex-shrink-0">
                            <img src="/static/icons/sockets/background-19.png" alt="Cloak socket background" class="absolute inset-0 w-full h-full">
                            <img src="/static/icons/sockets/overlay-19.png" alt="Cloak socket overlay" class="absolute inset-0 w-full h-full">
                        </div>
                    </template>
                    
                    <!-- Primary sockets (type 22) -->
                    <template x-for="i in (selectedEquipment && selectedEquipment.sockets && selectedEquipment.sockets.primary) || 0" :key="'primary-' + i">
                        <div class="w-8 h-8 relative flex-shrink-0">
                            <img src="/static/icons/sockets/background-22.png" alt="Primary socket background" class="absolute inset-0 w-full h-full">
                            <img src="/static/icons/sockets/overlay-22.png" alt="Primary socket overlay" class="absolute inset-0 w-full h-full">
                        </div>
                    </template>
                    
                    <!-- Vital sockets (type 23) -->
                    <template x-for="i in (selectedEquipment && selectedEquipment.sockets && selectedEquipment.sockets.vital) || 0" :key="'vital-' + i">
                        <div class="w-8 h-8 relative flex-shrink-0">
                            <img src="/static/icons/sockets/background-23.png" alt="Vital socket background" class="absolute inset-0 w-full h-full">
                            <img src="/static/icons/sockets/overlay-23.png" alt="Vital socket overlay" class="absolute inset-0 w-full h-full">
                        </div>
                    </template>
                    
                    <!-- Basic sockets (type 1) -->
                    <template x-for="i in (selectedEquipment && selectedEquipment.sockets && selectedEquipment.sockets.basic) || 0" :key="'basic-' + i">
                        <div class="w-8 h-8 relative flex-shrink-0">
                            <img src="/static/icons/sockets/background-1.png" alt="Basic socket background" class="absolute inset-0 w-full h-full">
                            <img src="/static/icons/sockets/overlay-1.png" alt="Basic socket overlay" class="absolute inset-0 w-full h-full">
                        </div>
                    </template>
                    
                    <!-- PVP sockets (type 18) -->
                    <template x-for="i in (selectedEquipment && selectedEquipment.sockets && selectedEquipment.sockets.pvp) || 0" :key="'pvp-' + i">
                        <div class="w-8 h-8 relative flex-shrink-0">
                            <img src="/static/icons/sockets/background-18.png" alt="PVP socket background" class="absolute inset-0 w-full h-full">
                            <img src="/static/icons/sockets/overlay-18.png" alt="PVP socket overlay" class="absolute inset-0 w-full h-full">
                        </div>
                    </template>
                </div>
            </template>
            
            <!-- Missing Features Placeholder -->
            <template x-if="!isBuilderMode()">
                <div class="border-t border-lotro-border pt-2 mt-3">
                    <div class="bg-lotro-uncommon/10 border border-lotro-uncommon/30 rounded-lg p-2">
                                        <h4 class="text-xs font-medium text-lotro-uncommon mb-1">⚠️ Missing Features</h4>
                <div class="text-xs text-lotro-uncommon/80 space-y-0.5">
                            <div>• Class restrictions & Set bonuses</div>
                            <div>• Source information</div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</template>
<template x-if="!selectedEquipment">
    <div class="text-lotro-secondary text-center py-4">
        Select equipment to view details
    </div>
</template>
{% endset %}

<div x-data="equipmentPanel" x-init="$nextTick(() => init())">
    {{ database_panel('equipment', 'Equipment', filters_content, results_content, details_content) }}
</div>

<!-- Equipment Panel JavaScript -->
<script src="{{ url_for('static', path='js/database/equipment-filters.js') }}"></script>
<script src="{{ url_for('static', path='js/database/equipment-panel.js') }}"></script> 