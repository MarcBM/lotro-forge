{% from "database/components/base_panel.html" import database_panel %}

{% set filters_content %}
<!-- Filters placeholder -->
<div class="text-gray-400 text-center py-4">
    Filters coming soon
</div>
{% endset %}

{% set results_content %}
<!-- Item Grid -->
<div class="grid grid-cols-3 gap-4">
    <template x-for="(item, index) in items" :key="item.key">
        <div class="bg-lotro-darker rounded-lg border border-lotro-border p-4 hover:border-lotro-gold transition-colors duration-200 cursor-pointer relative h-24"
             @click="selectItem(item)">
            <!-- Item Key -->
            <div class="absolute top-1 left-1 text-xs text-gray-500" 
                 x-text="item.key.toString().replace(/(\d{5})(\d+)/, '$1 $2')"></div>
            
            <!-- Main Content -->
            <div class="flex items-center gap-3 h-full pt-2">
                <!-- Item Icon (placeholder for now) -->
                <div class="w-10 h-10 bg-gray-700 rounded flex-shrink-0"></div>
                
                <!-- Item Name -->
                <h3 class="text-sm font-medium line-clamp-2 leading-tight flex-1"
                    :class="{
                        'text-white': item.quality === 'COMMON',
                        'text-yellow-300': item.quality === 'UNCOMMON',
                        'text-purple-400': item.quality === 'RARE',
                        'text-teal-400': item.quality === 'INCOMPARABLE',
                        'text-orange-400': item.quality === 'LEGENDARY'
                    }"
                    x-text="item.name"></h3>
            </div>
            
            <!-- EV Value -->
            <div class="absolute bottom-1 right-2 text-sm text-gray-400">
                <span x-text="(item.ev || '0.00')"></span>
            </div>
        </div>
    </template>
</div>
{% endset %}

{% set details_content %}
<!-- Item Details -->
<template x-if="selectedItem">
    <div class="space-y-4">
        <!-- Icon and Title -->
        <div class="space-y-2">
            <!-- Icon and Title -->
            <div class="flex items-start gap-4">
                <!-- Item Icon (placeholder for now) -->
                <div class="w-16 h-16 bg-gray-700 rounded flex-shrink-0"></div>
                
                <!-- Item Info -->
                <div class="flex-1 min-w-0">
                    <!-- Title area with fixed height -->
                    <div class="h-16 flex items-center">
                        <h3 class="text-xl font-bold line-clamp-2"
                            :class="{
                                'text-white': selectedItem.quality === 'COMMON',
                                'text-yellow-300': selectedItem.quality === 'UNCOMMON',
                                'text-purple-400': selectedItem.quality === 'RARE',
                                'text-teal-400': selectedItem.quality === 'INCOMPARABLE',
                                'text-orange-400': selectedItem.quality === 'LEGENDARY'
                            }"
                            x-text="selectedItem.name"></h3>
                    </div>
                </div>
            </div>

            <!-- Baseline Stats Row -->
            <div class="flex justify-between items-center text-sm text-gray-400 -mt-1">
                <div>
                    <span>iLvl: </span>
                    <span x-text="selectedItem.base_ilvl"></span>
                </div>
                <div class="text-gray-500">
                    <template x-if="selectedItem.armour_type && selectedItem.slot === 'OFF_HAND'">
                        <span x-text="selectedItem.armour_type"></span>
                    </template>
                    <template x-if="selectedItem.armour_type && selectedItem.slot !== 'OFF_HAND'">
                        <span x-text="selectedItem.slot + ' / ' + selectedItem.armour_type"></span>
                    </template>
                    <template x-if="!selectedItem.armour_type">
                        <span x-text="selectedItem.slot"></span>
                    </template>
                </div>
                <div x-text="(selectedItem.ev || '0.00')"></div>
            </div>
            
            <!-- ARMOUR stat above the line -->
            <template x-if="concreteItem && concreteItem.stat_values && concreteItem.stat_values.find(s => s.stat_name === 'ARMOUR')">
                <div class="flex justify-between text-sm text-gray-400 mb-2">
                    <span>ARMOUR</span>
                    <span class="text-gray-300" x-text="Math.floor(concreteItem.stat_values.find(s => s.stat_name === 'ARMOUR').value)"></span>
                </div>
            </template>
            
            <!-- Item Stats -->
            <div class="border-t border-lotro-border pt-3">
                <div class="text-sm text-gray-400 space-y-1">
                    <!-- Other stats -->
                    <template x-if="concreteItem && concreteItem.stat_values">
                        <div class="space-y-1">
                            <template x-for="stat in concreteItem.stat_values.filter(s => s.stat_name !== 'ARMOUR')" :key="stat.stat_name">
                                <div class="flex justify-between">
                                    <span x-text="stat.stat_name"></span>
                                    <span class="text-gray-300" x-text="Math.floor(stat.value)"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</template>
<template x-if="!selectedItem">
    <div class="text-gray-400 text-center py-4">
        Select an item to view details
    </div>
</template>
{% endset %}

<div x-data="itemsPanel" x-init="$nextTick(() => init())">
    {{ database_panel('items', 'Items Database', filters_content, results_content, details_content) }}
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('itemsPanel', () => ({
        searchQuery: '',
        items: [],
        selectedItem: null,
        concreteItem: null,
        loading: false,
        
        init() {
            // Initialize with empty array to ensure reactivity
            this.items = [];
            // Initial load with a fixed limit of 99 (multiple of 3)
            this.loadItems(0, 99);
            
            // Listen for load-more events from the base panel
            window.addEventListener('load-more', this.handleLoadMore.bind(this));
        },

        handleLoadMore(event) {
            if (event.detail.panelId !== 'items') return;
            this.loadMoreItems(event.detail.offset, event.detail.limit);
        },
        
        async loadItems(offset, limit) {
            if (this.loading) return;
            
            try {
                this.loading = true;
                const response = await fetch(`/api/items/?limit=${limit}&skip=${offset}`);
                if (!response.ok) {
                    throw new Error('Failed to load items');
                }
                
                const data = await response.json();
                // Use Alpine's reactive array update
                this.items = data;
                // Update pagination state in the base panel
                this.$dispatch('update-pagination', { 
                    hasMore: data.length === limit,
                    offset: offset + limit,
                    newItems: data
                });
            } catch (error) {
                console.error('Error loading items:', error);
                this.items = [];
                this.$dispatch('update-pagination', { 
                    hasMore: false,
                    offset: offset,
                    newItems: []
                });
            } finally {
                this.loading = false;
            }
        },

        async loadMoreItems(offset, limit) {
            if (this.loading) return;
            
            try {
                this.loading = true;
                const response = await fetch(`/api/items/?limit=${limit}&skip=${offset}`);
                if (!response.ok) {
                    throw new Error('Failed to load more items');
                }
                
                const data = await response.json();
                // Use Alpine's reactive array update
                this.items = [...this.items, ...data];
                // Update pagination state in the base panel
                this.$dispatch('update-pagination', { 
                    hasMore: data.length === limit,
                    offset: offset + limit,
                    newItems: data
                });
            } catch (error) {
                console.error('Error loading more items:', error);
                this.$dispatch('update-pagination', { 
                    hasMore: false,
                    offset: offset,
                    newItems: []
                });
            } finally {
                this.loading = false;
            }
        },

        async selectItem(item) {
            this.selectedItem = item;
            try {
                const response = await fetch(`/api/items/${item.key}/concrete?ilvl=${item.base_ilvl}`);
                if (!response.ok) {
                    throw new Error('Failed to load concrete item');
                }
                this.concreteItem = await response.json();
            } catch (error) {
                console.error('Error loading concrete item:', error);
                this.concreteItem = null;
            }
        }
    }));
});
</script> 